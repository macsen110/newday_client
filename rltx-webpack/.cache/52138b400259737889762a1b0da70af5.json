{"remainingRequest":"/Users/macsen/Desktop/rltx-webpack/src/car/car.js","dependencies":[{"path":"/Users/macsen/Desktop/rltx-webpack/src/car/car.js","mtime":1511527692000},{"path":"/Users/macsen/Desktop/rltx-webpack/node_modules/_babel-loader@6.2.10@babel-loader/lib/index.js","mtime":1481808750000},{"path":"/Users/macsen/Desktop/rltx-webpack/node_modules/_cache-loader@1.2.0@cache-loader/dist/cjs.js","mtime":1510929699000}],"contextDependencies":[],"result":["/**\n * menu.js\n * Created by zhangyc on 17/6/7.a\n */\n\n/* globals BMap, BMAP_ANCHOR_TOP_LEFT, BMAP_ANCHOR_TOP_LEFT, BMAP_ANCHOR_TOP_LEFT, BMAP_NAVIGATION_CONTROL_SMALL, mapTool */\n\nimport { getCarType, getPosition, getAddress } from '../../api/carServer';\nimport { dateFormat } from '../../api/Utils';\nimport { removeClass } from '../../api/classUtil';\n// import { truckSize, truckCarry } from '../../api/DataSourceService';\nimport * as ApiConst from '../../api/ApiConst';\n\nconst map = new BMap.Map('mapContent'),\n  axios = require('axios'),\n  lengthUnit = {},\n  carryUnit = {},\n  TRUCK_MODEL_DATA = require('../../api/TruckModelData').list;\n\nrequire('./labMap.js');\nrequire('../public.js');\n\nlet sideList = [];\n\n// 计算左侧列表和地图的高度\nfunction initHeight() {\n  const mapTruckList = document.getElementsByClassName('ml-bd')[0],\n    mapContent = document.getElementById('mapContent'),\n    listRealheight = window.innerHeight - 168,\n    MapRealHeight = window.innerHeight - 70,\n    Unit = 'px',\n    ListHeight = listRealheight + Unit,\n    MapHeight = MapRealHeight + Unit;\n  mapTruckList.style.height = ListHeight;\n  mapContent.style.height = MapHeight;\n}\n\nwindow.onresize = initHeight;\ninitHeight();\n\nfunction initCarType() {\n  getCarType((success) => {\n    const renderList = success.content,\n      truckType = document.getElementById('truckType');\n    renderList.forEach((element) => {\n      const option = document.createElement('option');\n      option.innerHTML = element.tag;\n      option.value = element.tag;\n      truckType.appendChild(option);\n    });\n  });\n}\n\ninitCarType();\n\n// 初始化地图控件\nfunction initMap(lat, lng) {\n  // 默认指到北京\n  const lat1 = lat || '39.915',\n    lng1 = lng || '116.404',\n    point = new BMap.Point(lng1, lat1),\n    topLeftControl = new BMap.ScaleControl({ anchor: BMAP_ANCHOR_TOP_LEFT }),\n    topLeftNavigation = new BMap.NavigationControl(),\n    topRightNavigation = new BMap.NavigationControl({ anchor: BMAP_ANCHOR_TOP_LEFT, type: BMAP_NAVIGATION_CONTROL_SMALL });\n  map.centerAndZoom(point, 6);\n  map.addControl(topLeftControl);\n  map.addControl(topLeftNavigation);\n  map.addControl(topRightNavigation);\n  map.enableScrollWheelZoom(true);\n}\n\n// 设置覆盖物\nfunction showMask(list) {\n  list.forEach((element) => {\n    const pt = new BMap.Point(element.lng, element.lat),\n      myIcon = new BMap.Icon('../static/img/truck_alarm.png', new BMap.Size(20, 32), {\n        anchor: new BMap.Size(10, 30)\n      }),\n      marker = new BMap.Marker(pt, { icon: myIcon }),\n      obj = element,\n      opts = {\n        width: 250,     // 信息窗口宽度\n        height: 180     // 信息窗口高度\n      },\n      recordTime = dateFormat(obj.recordTime),\n      template = `<div class='content'>\n        <div class='map-header'>\n          <a class=\"truck_detail\" target=\"_blank\">${obj.handle}</a>\n          <span class='truck-tag'>自有</span>\n          <span class=\"truck-tag ts-grey\">GPS</span>\n        </div>\n        <div class='map-content'>\n          <ul>\n            <li><em class=\"truck-role\">主</em></li>\n            <li class=\"copilot\"><em class=\"truck-role\">副</em></li>\n          </ul>\n          <div class=\"carDetail\">\n            <p>车型：</p><p>车辆位置:</p><p>定位时间:${recordTime}</p>\n          </div>\n        </div>\n        <div class='map-footer'>\n          <a class=\"btn-grey\" target=\"_blank\" href=\"/car/track.html?${element.handle}\">车辆轨迹</a>\n          <a class=\"btn-grey\" target=\"_blank\" href=\"javascript:;\">车辆详情</a>\n        </div>\n      </div>`,\n      infoWindow = new BMap.InfoWindow(template, opts);\n    // 将标注添加到地图中\n    getAddress({\n      type: '1',\n      lat: element.lat,\n      lng: element.lng\n    }, (success) => {\n      console.log(success);\n    });\n    map.addOverlay(marker);\n    // 获取左侧列表的点击控件\n    // sideList.forEach((listElement) => {\n    for (let i = 0, len = sideList.length; i < len; i++) {\n      if (sideList[i].truckLicenseNo === element.handle) {\n        const truckLicenseNo = sideList[i].truckLicenseNo,\n          querypre = 'truckCode',\n          clickTarget = document.getElementById(querypre + truckLicenseNo);\n        clickTarget.addEventListener('click', () => {\n          map.openInfoWindow(infoWindow, pt);\n        });\n        break;\n      }\n    }\n    // });\n    marker.addEventListener('click', () => {\n      map.openInfoWindow(infoWindow, pt);\n    });\n  });\n}\n\n// 获取左侧车辆列表\nfunction refreshList() {\n  const listObj = {},\n    pageNumber = document.getElementById('pageNumber').value,\n    searchName = document.getElementById('truckLicenseNo').value,\n    truckType = document.getElementById('truckType').value;\n  listObj.size = 10;\n  listObj.page = pageNumber || 1;\n  if (searchName) {\n    listObj.truckLicenseNo = searchName;\n    listObj.page = 1;\n  }\n  if (truckType) {\n    listObj.truckTagList = truckType;\n    listObj.page = 1;\n  }\n  // getSideList(listObj, (res) => {\n  //   const appendBox = document.getElementById('map-truck-list'),\n  //     searchList = [],\n  //     reslist = res.content,\n  //     totlePage = document.getElementById('totlePage');\n  //   sideList = res.content;\n  //   totlePage.value = Math.ceil(res.total / listObj.size);\n  //   appendBox.innerHTML = '';\n  //   // 生成左侧列表\n  //   for (let i = 0, len = reslist.length; i < len; i++) {\n  //     searchList.push(reslist[i].truckLicenseNo);\n  //     const li = document.createElement('li'),\n  //       span = document.createElement('span'),\n  //       span1 = document.createElement('span'),\n  //       a = document.createElement('span'),\n  //       p1 = document.createElement('p'),\n  //       p2 = document.createElement('p'),\n  //       em1 = document.createElement('em'),\n  //       em2 = document.createElement('em'),\n  //       strong = document.createElement('strong'),\n  //       d = ',',\n  //       f = '-',\n  //       pre = 'truckCode';\n  //     let model = '-,',\n  //       model1 = '-,',\n  //       model2 = '-';\n  //     if (reslist[i].truckModelName) {\n  //       model = reslist[i].truckModelName ? reslist[i].truckModelName + d : f + d;\n  //     }\n  //     console.log(model);\n  //     if (reslist[i].truckLength || reslist[i].truckLengthUnitCode) {\n  //       model1 = reslist[i].truckLength ? reslist[i].truckLength : f;\n  //       console.log(`model1:${model1}`);\n  //       if (model1 !== '-') {\n  //         model1 += reslist[i].truckLengthUnitCode ? reslist[i].truckLengthUnitCode : f;\n  //         console.log(unit[reslist[i].truckLengthUnitCode]);\n  //         console.log(unit[1]);\n  //         console.log(`1model1:${model1}`);\n  //       } else {\n  //         model1 += reslist[i].truckLengthUnitCode ? reslist[i].truckLengthUnitCode : '';\n  //         console.log(`2model1:${model1}`);\n  //       }\n  //       model1 += d;\n  //       console.log(`3model1:${model1}`);\n  //     }\n  //     if (reslist[i].regTonnage || reslist[i].regTonnageUnitCode) {\n  //       model2 = reslist[i].regTonnage ? reslist[i].regTonnage : '-';\n  //       if (model2 !== '-') {\n  //         model2 += reslist[i].regTonnageUnitCode ? reslist[i].regTonnageUnitCode : f;\n  //       } else {\n  //         model2 += reslist[i].regTonnageUnitCode ? reslist[i].regTonnageUnitCode : '';\n  //       }\n  //       model2 += d;\n  //     }\n  //     li.id = pre + reslist[i].truckLicenseNo;\n  //     a.className = 'truck_detail';\n  //     // a.target = '_blank';\n  //     // a.href = `/truck/add.html?${reslist[i].code}`;\n  //     /* eslint no-script-url: \"error\"*/\n  //     // a.href = 'javascript:void(0);';\n  //     a.setAttribute('data-link', `/truck/add.html?${reslist[i].code}`);\n  //     a.setAttribute('data-title', '车辆详情');\n  //     a.innerHTML = reslist[i].truckLicenseNo;\n  //     span.className = 'sequence';\n  //     span.innerHTML = i + 1;\n  //     p1.className = 'truck-id';\n  //     p1.setAttribute('data-truck-license', reslist[i].truckLicenseNo);\n  //     p2.className = 'truck-info';\n  //     // p2.innerHTML = model + model1 + model2;\n  //     em1.className = 'truck-tag';\n  //     // em1.innerHTML = '自有';\n  //     em1.innerHTML = reslist[i].truckTag ? reslist[i].truckTag : '';\n  //     em2.className = 'truck-tag ts-grey hide';\n  //     em2.innerHTML = 'gps';\n  //     span1.className = 'running-status fr';\n  //     span1.appendChild(strong);\n  //     p1.appendChild(span1);\n  //     p1.appendChild(a);\n  //     if (reslist[i].truckTag) {\n  //       p1.appendChild(em1);\n  //     }\n  //     p1.appendChild(em2);\n  //     li.appendChild(span);\n  //     li.appendChild(p1);\n  //     li.appendChild(p2);\n  //     appendBox.appendChild(li);\n  //   }\n  //   document.getElementById('pageNumber').value = listObj.page;\n  //   // 获取坐标地址\n  //   // todo []时不请求\n  //   if (searchList.length > 0) {\n  //     getPosition(searchList, (res1, err) => {\n  //     // 获取的坐标转换成百度坐标\n  //       const list = mapTool.transformPoint(res1.content);\n  //       let lat = 0,\n  //         lng = 0;\n  //       list.forEach((element) => {\n  //       // 遍历坐标\n  //         lat += parseFloat(element.lat);\n  //         lng += parseFloat(element.lng);\n  //       // 修改相关属性\n  //         const dom = document.getElementById(`truckCode${element.handle}`);\n  //         if (element.source === 'gps') {\n  //           removeClass(dom.getElementsByClassName('hide')[0], 'hide');\n  //         }\n  //         if (element.status) {\n  //           const targetDom = dom.getElementsByClassName('running-status')[0].getElementsByTagName('strong')[0];\n  //           switch (element.status) {\n  //             case 1:\n  //               targetDom.innerHTML = '正常';\n  //               break;\n  //             case 2:\n  //               targetDom.innerHTML = '停留';\n  //               break;\n  //             case 3:\n  //               targetDom.innerHTML = '异常';\n  //               break;\n  //             default:\n  //               break;\n  //           }\n  //         }\n  //       });\n  //       lat /= res1.content.length;\n  //       lng /= res1.content.length;\n  //       initMap(lat, lng);\n  //       showMask(list);\n  //       if (err) {\n  //         console.log(err);\n  //       }\n  //     });\n  //   } else {\n  //     document.getElementById('pageNumber').value = '0';\n  //     initMap(null, null);\n  //   }\n  // });\n\n  listObj.page = document.getElementById('pageNumber').value;\n  function getSide() {\n    return axios({\n      method: 'get',\n      url: `${ApiConst.BaseDomain}/truck/truck/list`,\n      params: listObj\n    });\n  }\n  function getSizeUnit() {\n    return axios({\n      method: 'get',\n      url: `${ApiConst.apiOrgConfigDomain}/measure_unit/truck.size/get`,\n      headers: { 'Accept': 'application/json' }\n    });\n  }\n\n  function getCarryUnit() {\n    return axios({\n      method: 'get',\n      url: `${ApiConst.apiOrgConfigDomain}/measure_unit/truck.carry/get`,\n      headers: { 'Accept': 'application/json' }\n    });\n  }\n  axios.all([getSide(), getSizeUnit(), getCarryUnit()])\n    .then(axios.spread((response, sizeUnitResult, carryUnitResult) => {\n      // 解析单位信息\n      sizeUnitResult.data.content.forEach((element) => {\n        lengthUnit[element.code] = element.codeName;\n      });\n      carryUnitResult.data.content.forEach((element) => {\n        carryUnit[element.code] = element.codeName;\n      });\n      const appendBox = document.getElementById('map-truck-list'),\n        searchList = [],\n        res = response.data,\n        reslist = res.content,\n        totlePage = document.getElementById('totlePage');\n      sideList = res.content;\n      totlePage.value = Math.ceil(res.total / listObj.size);\n      appendBox.innerHTML = '';\n      // 生成左侧列表\n      for (let i = 0, len = reslist.length; i < len; i++) {\n        searchList.push(reslist[i].truckLicenseNo);\n        const li = document.createElement('li'),\n          span = document.createElement('span'),\n          span1 = document.createElement('span'),\n          a = document.createElement('span'),\n          p1 = document.createElement('p'),\n          p2 = document.createElement('p'),\n          em1 = document.createElement('em'),\n          em2 = document.createElement('em'),\n          strong = document.createElement('strong'),\n          d = ',',\n          f = '-',\n          pre = 'truckCode';\n        let model = '-,',\n          model1 = '-,',\n          model2 = '-',\n          truckModelName = '';\n        for (let k = 0, len1 = TRUCK_MODEL_DATA.length; k < len1; k++) {\n          if (reslist[i].truckModelCode === TRUCK_MODEL_DATA[k].id) {\n            truckModelName = TRUCK_MODEL_DATA[k].value;\n            break;\n          }\n        }\n        if (truckModelName) {\n          model = truckModelName ? truckModelName + d : f + d;\n        }\n        if (reslist[i].truckLength || reslist[i].truckLengthUnitCode) {\n          model1 = reslist[i].truckLength ? reslist[i].truckLength : f;\n          if (model1 !== '-') {\n            model1 += reslist[i].truckLengthUnitCode ? (lengthUnit[reslist[i].truckLengthUnitCode] || f) : f;\n          } else {\n            model1 += reslist[i].truckLengthUnitCode ? (lengthUnit[reslist[i].truckLengthUnitCode] || '') : '';\n          }\n          model1 += d;\n        }\n        if (reslist[i].regTonnage || reslist[i].regTonnageUnitCode) {\n          model2 = reslist[i].regTonnage ? reslist[i].regTonnage : '-';\n          if (model2 !== '-') {\n            model2 += reslist[i].regTonnageUnitCode ? (carryUnit[reslist[i].regTonnageUnitCode] || f) : f;\n          } else {\n            model2 += reslist[i].regTonnageUnitCode ? (carryUnit[reslist[i].regTonnageUnitCode] || '') : '';\n          }\n        }\n        li.id = pre + reslist[i].truckLicenseNo;\n        a.className = 'truck_detail';\n        // a.target = '_blank';\n        // a.href = `/truck/add.html?${reslist[i].code}`;\n        /* eslint no-script-url: \"error\"*/\n        // a.href = 'javascript:void(0);';\n        a.setAttribute('data-link', `/truck/add.html?code=${reslist[i].code}&editable=false`);\n        a.setAttribute('data-title', '车辆详情');\n        a.innerHTML = reslist[i].truckLicenseNo;\n        span.className = 'sequence';\n        span.innerHTML = i + 1;\n        p1.className = 'truck-id';\n        p1.setAttribute('data-truck-license', reslist[i].truckLicenseNo);\n        p2.className = 'truck-info';\n        p2.innerHTML = model + model1 + model2;\n        em1.className = 'truck-tag';\n        // em1.innerHTML = '自有';\n        em1.innerHTML = reslist[i].truckTag ? reslist[i].truckTag : '';\n        em2.className = 'truck-tag ts-grey hide';\n        em2.innerHTML = 'gps';\n        span1.className = 'running-status fr';\n        span1.appendChild(strong);\n        p1.appendChild(span1);\n        p1.appendChild(a);\n        if (reslist[i].truckTag) {\n          p1.appendChild(em1);\n        }\n        p1.appendChild(em2);\n        li.appendChild(span);\n        li.appendChild(p1);\n        li.appendChild(p2);\n        appendBox.appendChild(li);\n      }\n      document.getElementById('pageNumber').value = listObj.page;\n      // 获取坐标地址\n      // todo []时不请求\n      if (searchList.length > 0) {\n        getPosition({\n          truckLicenseNo: searchList.join(',')\n        }, (res1, err) => {\n        // 获取的坐标转换成百度坐标\n          if (res1) {\n            const list = mapTool.transformPoint(res1.content);\n            let lat = 0,\n              lng = 0;\n            list.forEach((element) => {\n            // 遍历坐标\n              lat += parseFloat(element.lat);\n              lng += parseFloat(element.lng);\n            // 修改相关属性\n              const dom = document.getElementById(`truckCode${element.handle}`);\n              if (element.source === 'gps') {\n                removeClass(dom.getElementsByClassName('hide')[0], 'hide');\n              }\n              if (element.status) {\n                const targetDom = dom.getElementsByClassName('running-status')[0].getElementsByTagName('strong')[0];\n                switch (element.status) {\n                  case 1:\n                    targetDom.innerHTML = '正常';\n                    break;\n                  case 2:\n                    targetDom.innerHTML = '停留';\n                    break;\n                  case 3:\n                    targetDom.innerHTML = '异常';\n                    break;\n                  default:\n                    break;\n                }\n              }\n            });\n            lat /= res1.content.length;\n            lng /= res1.content.length;\n            initMap(lat, lng);\n            showMask(list);\n            if (err) {\n              console.log(err);\n            }\n          } else {\n            initMap(null, null);\n          }\n        });\n      } else {\n        document.getElementById('pageNumber').value = '0';\n        initMap(null, null);\n      }\n    }));\n}\n\nrefreshList();\ndocument.getElementById('search').onclick = function () {\n  refreshList();\n};\n\ndocument.getElementById('ucp-pre').onclick = function () {\n  const nowPage = parseInt(document.getElementById('pageNumber').value, 10);\n  if (nowPage > 1) {\n    document.getElementById('pageNumber').value -= 1;\n    document.getElementById('search').onclick();\n  }\n};\n\ndocument.getElementById('ucp-next').onclick = function () {\n  const nowPage = parseInt(document.getElementById('pageNumber').value, 10),\n    totlePage = parseInt(document.getElementById('totlePage').value, 10);\n  if (nowPage < totlePage) {\n    document.getElementById('pageNumber').value = nowPage + 1;\n    document.getElementById('search').onclick();\n  }\n};\n",null]}