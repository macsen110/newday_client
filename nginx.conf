
user  macsen staff;
worker_processes  1;

error_log  /usr/local/etc/nginx/logs/error.log;
error_log  /usr/local/etc/nginx/logs/notice.log  notice;
error_log  /usr/local/etc/nginx/logs/info.log  info;

#pid        /usr/local/etc/nginx/logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /usr/local/etc/nginx/logs/access.log  main;
    rewrite_log on;
    sendfile        on;
    tcp_nodelay     on;
    tcp_nopush     on;
    keepalive_timeout  120;
    gzip  on;
    client_max_body_size 50M;
    upstream myproject {
       server localhost:4000;
       
    }
    upstream websocket {
        server 127.0.0.1:3000;
    }
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    #日常工作开发用到的配置
    #
    server {
        listen 80;
        server_name s.maiyaole.com;
        root /Users/macsen/Desktop/yz/yao_resources/stable;
        location /css/ {
            concat on;
            concat_max_files 20;
            concat_unique off;
        }
        location /js/ {
            concat_types application/javascript;
            concat on;
            concat_max_files 20;
            concat_unique off;
        }
    }
    ##个人web 
    ## domain用到的配置
    server {
        listen 8020;
        location / {
            proxy_pass http://websocket;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }
    
    server {
        listen       80;
        server_name  dev.macsen318.com;
        charset utf-8; 
        root /Users/macsen/Desktop/Macsen/newday_client/;  
        add_header 'Access-Control-Allow-Origin' "http://dev.macsen318.com:9000" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
        add_header Access-Control-Allow-Credentials true;

        location / {
            index  index.html index.htm;
        }
        
        location /images/ {
            try_files $uri /images/default.jpg;
        }
        location /api/ {
            # add_header 'Access-Control-Allow-Origin' "http://dev.macsen318.com:9000" always;
            # add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            # add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
            # add_header Access-Control-Allow-Credentials true;
            # proxy_pass http://127.0.0.1:3000;
        }
        location /socket.io/ {
            #deny all;
            add_header 'Access-Control-Allow-Origin' "http://dev.macsen318.com:9000" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
            add_header Access-Control-Allow-Credentials true;

            proxy_pass http://websocket;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
        location /sockjs-node/ {
            proxy_pass http://myproject;
            proxy_redirect    off;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        location = /50x.html {
            root   html;
        }
        # proxy_connect_timeout 180;
        # proxy_send_timeout 180;
        # proxy_read_timeout 180;
        # proxy_set_header Host $host;
        # proxy_set_header X-Forwarder-For $remote_addr;
        #proxy the PHP scripts to Apache listening on 127.0.0.1:80;
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }
    server {
        listen 80;
        server_name www.macsen318.com macsen318.com;
        rewrite ^(.*)$  https://$host$1 permanent;
    }
    server {
        listen               443 ssl http2;
        #ssl                  on;
        server_name www.macsen318.com macsen318.com;
        ssl_certificate     /Users/macsen/Desktop/Macsen/ssl/macsen318.chained.crt;  
	    ssl_certificate_key /Users/macsen/Desktop/Macsen/ssl/macsen318.com.key; 
        keepalive_timeout    70;
        ssl_session_timeout 10m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        #ssl_ciphers ECDHE-SHA384:ECDHE-RSA-:ECDHE:!DES:!3DES:!MD5:!DSS:!PKS;
        ssl_session_cache builtin:1000 shared:SSL:10m;
        resolver 8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout 5s;
        root /Users/macsen/Desktop/Macsen/newday_client/; 
        location / {
            
        }
        location ^~ /zone {
            rewrite ^\/zone\/?(?!.*[.](html|js|css)$).*$ /z_dist/ last;
            alias /Users/macsen/Desktop/Macsen/newday_client/zone/dist/;
        }
        location /z_dist/ {
            #deny all;
            alias /Users/macsen/Desktop/Macsen/newday_client/zone/dist/;
            index index.html;
        }
        location ^~ /mch {
            alias /Users/macsen/Desktop/Macsen/newday_client/mch/dist/;
            index index.html;
        }
        location /api/ {
            proxy_pass http://127.0.0.1:3000;
        }
        location /socket.io/ {
            proxy_pass http://websocket;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
        #exec 404 pages
        error_page 404 = @fallback;
        location @fallback {
            
           proxy_pass http://www.baidu.com;

        }
    }
    server {
        listen 443 ssl http2;
        listen 80;
        server_name res.macsen318.com;
        ssl_certificate /Users/macsen/Desktop/Macsen/newday_server/resource/res.chained.crt;
        ssl_certificate_key /Users/macsen/Desktop/Macsen/newday_server/resource/res.macsen318.com.key;
        ssl_session_timeout 10m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        #ssl_ciphers ECDHE-SHA384:ECDHE-RSA-:ECDHE:!DES:!3DES:!MD5:!DSS:!PKS;
        ssl_session_cache builtin:1000 shared:SSL:10m;
        resolver 8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout 5s;
        root /Users/macsen/Desktop/Macsen/newday_server/resource;
        location / {
            try_files $uri /images/default.jpg;
        }
    }

    
    include servers/*;
}
